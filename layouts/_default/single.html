{{ define "main" }}

{{/* TOC Sidebar - JS will populate and hide if no headings */}}
<aside class="toc-sidebar" id="toc-sidebar">
    <button class="toc-toggle" id="toc-toggle" aria-label="Toggle table of contents">
        <span class="toc-toggle-icon"></span>
    </button>
    <div class="toc-content">
        <h2 class="toc-title">Contents</h2>
        <nav id="toc-list"></nav>
    </div>
</aside>

<main>
    <div class="post">
        {{ partial "single/title.html" . }}

        {{ partial "single/header.html" . }}

        {{ $footnoteReturnLink := (printf "${1}%s${2}" "â†¥") }}

        {{- $columns := .Params.columns | default 2 -}}
        <div class="post-content{{ if eq $columns 1 }} single-column{{ end }}">
            {{- $Content := .Content -}}
            {{- if .Site.Params.DropCap.Enable }}
            {{- /* Extract content before footnotes to avoid drop caps in footnotes */ -}}
            {{- $mainContent := $Content -}}
            {{- if strings.Contains $Content `<section class="footnotes"` -}}
                {{- $mainContent = index (split $Content `<section class="footnotes"`) 0 -}}
            {{- end -}}
            {{- /* Match <p> followed by optional inline tags, then optional quote + letter */ -}}
            {{- /* Quotes can be literal chars or HTML entities (&ldquo; &lsquo;) */ -}}
            {{- $regexPatternDropCap := `(<p>(?:<(?:em|strong|i|b|a[^>]*|span[^>]*)>)*)((?:&ldquo;|&lsquo;|["'""''])?[A-Za-z])(.+?</p>)` -}}
            {{- $regexReplacementDropCap := `$1<span class="drop-cap">$2</span>$3` -}}
            {{- $firstParagraphOld := (delimit (findRE $regexPatternDropCap $mainContent 1) " ") -}}
            {{- if $firstParagraphOld -}}
                {{- $firstParagraphNew := (replaceRE $regexPatternDropCap $regexReplacementDropCap $firstParagraphOld) -}}
                {{- $Content = replace $Content $firstParagraphOld $firstParagraphNew 1 -}}
            {{- end -}}
        {{- end }}
            {{- /* Apply abbr styling to acronyms, then strip abbr tags from inside math and HTML attributes */ -}}
        {{- $Content = $Content | replaceRE "\\b([A-Z][A-Z0-9\\-]{2,})\\b" "<abbr>$1</abbr>" -}}
        {{- $Content = $Content | replaceRE `(\\\(.*?)<abbr>([A-Z0-9]+)</abbr>(.*?\\\))` "$1$2$3" -}}
        {{- /* Strip abbr tags from inside HTML tag attributes (e.g., src, href) - apply multiple times for multiple matches */ -}}
        {{- range seq 5 -}}
            {{- $Content = $Content | replaceRE `(<[a-zA-Z][^>]*)<abbr>([^<]+)</abbr>([^>]*>)` "$1$2$3" -}}
        {{- end -}}
        {{- $Content | safeHTML -}}
        </div>
    </div>
</main>

{{ end }}
