<a href="{{ .Permalink | relURL }}" class="catalogue-item" data-tags="{{ delimit .Params.tags "," }}">
    <div>
        <time datetime="{{ .PublishDate }}" class="catalogue-time">{{ i18n "publishdate" . }}</time>{{ if .Site.Params.DisplayReadTime }}<span class="catalogue-time"> | {{ .ReadingTime }}&nbsp;minute read</span>{{ end }}
        <h1 class="catalogue-title">{{ .Title }}</h1>
        <div class="catalogue-line"></div>

        {{ if not .Site.Params.DisableSummary }}
            <div class="catalogue-summary">
                {{- $wordLimit := .Site.Params.SummaryWordLimit | default 50 -}}
                {{- $content := "" -}}
                {{- if isset .Params "summary" -}}
                    {{- $content = .Params.Summary | markdownify -}}
                {{- else -}}
                    {{- $content = .Content -}}
                {{- end -}}
                {{- /* Clean up unwanted elements while preserving formatting */ -}}
                {{- $content = $content | replaceRE `<sup id="fnref[^"]*"[^>]*>.*?</sup>` "" -}}
                {{- $content = $content | replaceRE `(?s)<h2.*` "" -}}
                {{- $content = $content | replaceRE `<a[^>]*>([^<]*)</a>` "$1" -}}
                {{- /* Extract paragraphs and accumulate until word limit */ -}}
                {{- $paragraphs := findRE `(?s)<p>.*?</p>` $content -}}
                {{- $result := "" -}}
                {{- $wordCount := 0 -}}
                {{- $needsEllipsis := false -}}
                {{- range $paragraphs -}}
                    {{- $paraPlain := . | plainify | replaceRE `\s+` " " | strings.TrimSpace -}}
                    {{- $paraWords := split $paraPlain " " -}}
                    {{- $paraWordCount := len $paraWords -}}
                    {{- if and (lt $wordCount $wordLimit) (gt $paraWordCount 0) -}}
                        {{- $newCount := add $wordCount $paraWordCount -}}
                        {{- if le $newCount (add $wordLimit 20) -}}
                            {{- $result = printf "%s%s" $result . -}}
                            {{- $wordCount = $newCount -}}
                            {{- if gt $newCount $wordLimit -}}
                                {{- $needsEllipsis = true -}}
                            {{- end -}}
                        {{- else if eq $wordCount 0 -}}
                            {{- $truncatedWords := first $wordLimit $paraWords -}}
                            {{- $truncatedText := delimit $truncatedWords " " -}}
                            {{- $result = printf "<p>%s…</p>" $truncatedText -}}
                            {{- $wordCount = $wordLimit -}}
                        {{- else -}}
                            {{- $needsEllipsis = true -}}
                            {{- break -}}
                        {{- end -}}
                    {{- else if ge $wordCount $wordLimit -}}
                        {{- break -}}
                    {{- end -}}
                {{- end -}}
                {{- /* Add ellipsis if we truncated */ -}}
                {{- if and $needsEllipsis (not (strings.HasSuffix $result "…</p>")) -}}
                    {{- $result = replaceRE `</p>$` "…</p>" $result -}}
                {{- end -}}
                {{- /* Apply abbr styling to acronyms, avoiding math expressions and HTML attributes */ -}}
                {{- $result = $result | replaceRE "\\b([A-Z][A-Z0-9\\-]{2,})\\b" "<abbr>$1</abbr>" -}}
                {{- $result = $result | replaceRE `(\\\(.*?)<abbr>([A-Z0-9]+)</abbr>(.*?\\\))` "$1$2$3" -}}
                {{- /* Strip abbr tags from inside HTML tag attributes */ -}}
                {{- range seq 5 -}}
                    {{- $result = $result | replaceRE `(<[a-zA-Z][^>]*)<abbr>([^<]+)</abbr>([^>]*>)` "$1$2$3" -}}
                {{- end -}}
                {{- $result | safeHTML -}}
            </div>
        {{ end }}
    </div>
</a>
